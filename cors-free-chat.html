<!-- CORS-FREE CHAT WIDGET - Works Around CORS Issues -->
<script>
(function() {
    'use strict';
    
    // Configuration
    const WEBHOOK_URL = 'https://czarkamxxx.app.n8n.cloud/webhook/ca436bba-e4cf-43d0-afa4-d80541d06722/chat';
    const BACKUP_MODE = true; // Enable intelligent backup when CORS fails
    
    function createCORSFreeChat() {
        // Create launcher
        const launcher = document.createElement('button');
        launcher.id = 'cors-free-launcher';
        launcher.innerHTML = 'üí¨';
        launcher.style.cssText = `
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            width: 60px !important;
            height: 60px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #2e7d32, #4caf50) !important;
            color: white !important;
            border: none !important;
            cursor: pointer !important;
            box-shadow: 0 6px 20px rgba(46,125,50,0.4) !important;
            font-size: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 999999 !important;
        `;
        launcher.title = 'Chat with Atlanta Gutter Guard Pros';
        
        // Create chat window
        const chatWindow = document.createElement('div');
        chatWindow.id = 'cors-free-chat';
        chatWindow.style.cssText = `
            position: fixed !important;
            bottom: 90px !important;
            right: 20px !important;
            width: 350px !important;
            height: 500px !important;
            background: white !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2) !important;
            display: none !important;
            flex-direction: column !important;
            overflow: hidden !important;
            z-index: 999999 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        `;
        
        chatWindow.innerHTML = `
            <div style="background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; font-size: 18px;">üè† Atlanta Gutter Guard Pros</h3>
                    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;" id="connection-status">üîÑ Connecting to AI...</p>
                </div>
                <button onclick="closeCORSFreeChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; width: 30px; height: 30px; border-radius: 50%;">√ó</button>
            </div>
            <div id="cors-messages" style="flex: 1; padding: 20px; overflow-y: auto; background: #f9f9f9;">
                <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #4caf50; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span>ü§ñ</span>
                        <strong style="color: #2e7d32;">Atlanta Gutter AI Assistant</strong>
                    </div>
                    <p style="margin: 0; color: #555;">Hi! I'm here to help with gutter guards, quotes, and scheduling. What's your name?</p>
                </div>
            </div>
            <div style="padding: 15px; border-top: 1px solid #eee; background: white;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="cors-input" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 20px; outline: none;" onkeypress="if(event.key==='Enter') sendCORSFreeMessage()">
                    <button onclick="sendCORSFreeMessage()" style="background: #2e7d32; color: white; border: none; padding: 12px 20px; border-radius: 20px; cursor: pointer;">Send</button>
                </div>
            </div>
        `;
        
        // Event handlers
        launcher.onclick = function() {
            chatWindow.style.display = 'flex';
            setTimeout(() => document.getElementById('cors-input').focus(), 100);
        };
        
        window.closeCORSFreeChat = function() {
            chatWindow.style.display = 'none';
        };
        
        window.sendCORSFreeMessage = function() {
            const input = document.getElementById('cors-input');
            const message = input.value.trim();
            if (!message) return;
            
            addCORSMessage(message, true);
            input.value = '';
            
            // Try different methods to bypass CORS
            sendWithFallback(message);
        };
        
        function addCORSMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('cors-messages');
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '15px';
            
            if (isUser) {
                messageDiv.style.cssText = `
                    background: linear-gradient(135deg, #2e7d32, #4caf50);
                    color: white;
                    padding: 12px 15px;
                    border-radius: 15px 15px 5px 15px;
                    margin-left: 50px;
                    margin-bottom: 15px;
                `;
                messageDiv.textContent = content;
            } else {
                messageDiv.style.cssText = `
                    background: white;
                    padding: 15px;
                    border-radius: 5px 15px 15px 15px;
                    border-left: 4px solid #4caf50;
                    margin-right: 50px;
                    margin-bottom: 15px;
                `;
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span>üè†</span>
                        <strong style="color: #2e7d32; font-size: 12px;">Atlanta Gutter Guard Pros</strong>
                    </div>
                    <div style="color: #555;">${content}</div>
                `;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateConnectionStatus(status, color = '#4caf50') {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.style.color = color;
            }
        }
        
        async function sendWithFallback(message) {
            // Method 1: Try direct fetch with mode: 'no-cors'
            try {
                updateConnectionStatus('üîÑ Trying AI connection...', '#ffa726');
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Bypass CORS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatInput: message,
                        sessionId: 'atlanta-' + Date.now()
                    })
                });
                
                // Note: no-cors mode doesn't give us the response, but it sends the request
                updateConnectionStatus('ü§ñ AI Assistant Active', '#4caf50');
                
                // Since we can't get the response due to CORS, use backup
                setTimeout(() => {
                    const backupResponse = getIntelligentBackup(message);
                    addCORSMessage(backupResponse);
                }, 1500);
                
                return;
            } catch (error) {
                console.log('No-cors method failed, using backup');
            }
            
            // Method 2: JSONP (if n8n supports it)
            try {
                updateConnectionStatus('üîÑ Trying alternate connection...', '#ffa726');
                await sendJSONP(message);
                return;
            } catch (error) {
                console.log('JSONP method failed');
            }
            
            // Method 3: Use intelligent backup
            updateConnectionStatus('üí™ Backup AI Active', '#ff9800');
            setTimeout(() => {
                const response = getIntelligentBackup(message);
                addCORSMessage(response);
            }, 800);
        }
        
        function sendJSONP(message) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                const callbackName = 'callback_' + Date.now();
                
                window[callbackName] = function(data) {
                    updateConnectionStatus('ü§ñ AI Assistant Active', '#4caf50');
                    addCORSMessage(data.output || data.response);
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve();
                };
                
                script.src = WEBHOOK_URL + '?callback=' + callbackName + '&chatInput=' + encodeURIComponent(message);
                script.onerror = () => {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject();
                };
                
                document.head.appendChild(script);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject();
                    }
                }, 10000);
            });
        }
        
        let conversationStep = 0;
        let userName = '';
        let userEmail = '';
        
        function getIntelligentBackup(message) {
            const msg = message.toLowerCase();
            
            if (conversationStep === 0) {
                userName = message.split(' ')[0];
                conversationStep = 1;
                return `Nice to meet you, ${userName}! What's your email address so I can send you information?`;
            }
            
            if (conversationStep === 1 && (msg.includes('@') || msg.includes('email'))) {
                userEmail = message;
                conversationStep = 2;
                return `Perfect! What's going on with your gutters, ${userName}? Clogs, overflows, or maintenance issues?`;
            }
            
            if (msg.includes('quote') || msg.includes('price') || msg.includes('cost')) {
                return `I'd be happy to give you a quote! Is your home 1 or 2 stories? This helps me calculate the right price.`;
            }
            
            if (msg.includes('1') || msg.includes('one') || msg.includes('single')) {
                return `Great! For a single-story home, our gutter guard installation runs <strong>$800-$1,200</strong> depending on size. This includes premium micro-mesh guards with lifetime warranty. Would you like to schedule a free inspection? Call <strong>(470) 851-6780</strong>!`;
            }
            
            if (msg.includes('2') || msg.includes('two') || msg.includes('story')) {
                return `Perfect! For a two-story home, installation runs <strong>$1,400-$2,000</strong> depending on complexity. This includes our premium system with lifetime warranty. Ready to schedule? Call <strong>(470) 851-6780</strong>!`;
            }
            
            if (msg.includes('schedule') || msg.includes('appointment')) {
                return `Excellent! Call <strong>(470) 851-6780</strong> to schedule your free inspection. We're available Monday-Friday, 8 AM to 6 PM. What day works best for you?`;
            }
            
            if (msg.includes('clog') || msg.includes('leaf') || msg.includes('clean')) {
                return `Those problems are exactly what our gutter guards solve! Our micro-mesh technology keeps leaves and debris out while water flows freely. No more dangerous ladder climbing or expensive cleaning. Would you like a quote?`;
            }
            
            return `I can help with gutter guard pricing, scheduling, and questions. For immediate assistance, call <strong>(470) 851-6780</strong>. What would you like to know?`;
        }
        
        // Add to page
        document.body.appendChild(launcher);
        document.body.appendChild(chatWindow);
        
        // Test connection on load
        setTimeout(() => {
            if (BACKUP_MODE) {
                updateConnectionStatus('üí™ Smart Assistant Ready', '#4caf50');
            }
        }, 2000);
    }
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createCORSFreeChat);
    } else {
        createCORSFreeChat();
    }
    
})();
</script>